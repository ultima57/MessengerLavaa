<!DOCTYPE html>
<html style="font-size: 16px;" lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="utf-8">
    <meta name="keywords" content="​For &nbsp;register enter your username and password:, Input your login ​and password, ​Enter message and recipient:">
    <meta name="description" content="">
    <title>Lavaa messenger</title>
    <link rel="stylesheet" href="nicepage.css" media="screen">
    <link rel="stylesheet" href="Home.css" media="screen">
    <script class="u-script" type="text/javascript" src="jquery.js" defer=""></script>
    <script class="u-script" type="text/javascript" src="nicepage.js" defer=""></script>
    <meta name="generator" content="Nicepage 5.2.4, nicepage.com">
    <meta name="referrer" content="origin">
    <link id="u-theme-google-font" rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:100,100i,300,300i,400,400i,500,500i,700,700i,900,900i|Open+Sans:300,300i,400,400i,500,500i,600,600i,700,700i,800,800i">



    <script type="application/ld+json">        {
                "@context": "http://schema.org",
                "@type": "Organization",
                "name": "",
                "logo": "images/Logo.svg"
        }</script>
    <meta name="theme-color" content="#478ac9">
    <meta property="og:title" content="Home">
    <meta property="og:type" content="website">
</head>
<body data-home-page="Home.html" data-home-page-title="Home" class="u-body u-overlap u-overlap-transparent u-xl-mode" data-lang="en">
    <header class="u-clearfix u-container-align-center u-header u-header" id="sec-013f">
        <div class="u-clearfix u-sheet u-sheet-1">
            <a href="https://nicepage.com/k/dog-website-templates" class="u-image u-logo u-image-1" data-image-width="132" data-image-height="36">
                <img src="images/Logo.svg" class="u-logo-image u-logo-image-1">
            </a>
        </div>
    </header>
    <section class="skrollable u-align-center u-clearfix u-image u-parallax u-section-1" id="sendBtn" data-image-width="2000" data-image-height="1333">
        <h2 class="u-text u-text-1"> For register enter your username and password:</h2>
        <div class="u-expanded-width u-form u-form-1">
            <form action="https://forms.nicepagesrv.com/Form/Process" class="u-clearfix u-form-horizontal u-form-spacing-19 u-inner-form" style="padding: 18px;" source="email">
                <div class="u-form-group u-form-name u-label-none">
                    <label for="name-ef64" class="u-label">Name</label>
                    <input type="text"  id="emailReg" class="u-border-1 u-border-grey-30 u-input u-input-rectangle" required="">
                </div>
                <div class="u-form-email u-form-group u-label-none">
                    <label for="email-ef64" class="u-label">Email</label>
                    <input type="password"  id="passwordReg" class="u-border-1 u-border-grey-30 u-input u-input-rectangle" required="">
                </div>
                <div class="u-form-group u-form-submit">
                    <a href="#" class="u-black u-btn u-btn-round u-btn-submit u-button-style u-radius-50 u-text-custom-color-1 u-btn-1">Create account</a>
                    <input id="loginBtnReg" type="button" value="submit" class="u-form-control-hidden">
                </div>
   
                
            </form>
        </div>
        <h2 class="u-text u-text-2">Input your login ​and password</h2>
        <div class="u-expanded-width u-form u-form-2">
            <form action="https://forms.nicepagesrv.com/Form/Process" class="u-clearfix u-form-horizontal u-form-spacing-19 u-inner-form" style="padding: 18px;" source="email">
                <div class="u-form-group u-form-name u-label-none">
              
                    <input type="text"  id="email" class="u-border-1 u-border-grey-30 u-input u-input-rectangle" required="">
                </div>
                <div class="u-form-email u-form-group u-label-none">
                    <label for="email-ef64" class="u-label">Email</label>
                    <input type="Password"  id="password" class="u-border-1 u-border-grey-30 u-input u-input-rectangle" required="">
                </div>
                <div class="u-form-group u-form-submit">
                    <a href="#" class="u-black u-btn u-btn-round u-btn-submit u-button-style u-radius-50 u-text-custom-color-1 u-btn-2">Sign in</a>
                    <input id="loginBtn"  type="button"  class="u-form-control-hidden">
                </div>
          
               
            </form>
        </div>
        <h2 class="u-text u-text-3"> Enter message and recipient:</h2>
        <div class="u-expanded-width u-form u-form-3">
            <form action="https://forms.nicepagesrv.com/Form/Process" class="u-clearfix u-form-horizontal u-form-spacing-19 u-inner-form" style="padding: 18px;" source="email">
                <div class="u-form-group u-form-name u-label-none">
                    <label for="name-ef64" class="u-label">Name</label>
                    <input type="text" placeholder="Message" id="name-ef64" name="message" class="u-border-1 u-border-grey-30 u-input u-input-rectangle" required="">
                </div>
                <div class="u-form-email u-form-group u-label-none">
                    <label for="email-ef64" class="u-label">Email</label>
                    <input type="text" placeholder="Recipient" id="receiver" class="u-border-1 u-border-grey-30 u-input u-input-rectangle" required="">
                </div>
                <div class="u-form-group u-form-submit">
                    <a " class="u-black u-btn u-btn-round u-btn-submit u-button-style u-radius-50 u-text-custom-color-1 u-btn-3">Send message</a>
                    <input id="sendBtn"  type="submit" value="submit" class="u-form-control-hidden">
                </div>
        
                <input type="hidden" value="" name="recaptchaResponse">
                <input type="hidden" name="formServices" value="c494adacee7c845c2893cec1e34845ff">
            </form>
        </div>
    </section>
    <section class="skrollable skrollable-between u-align-center u-clearfix u-gradient u-section-2" id="sec-db27">
        <div class="u-clearfix u-sheet u-sheet-1"></div>
    </section>



    <section class="u-backlink u-clearfix u-grey-80">
        <a class="u-link" href="https://nicepage.com/website-templates" target="_blank">
            <span>Website Templates</span>
        </a>
        <p class="u-text">
            <span>created with</span>
        </p>
        <a class="u-link" href="" target="_blank">
            <span>Website Builder Software</span>
        </a>.
    </section>

    <div id="erorbar"></div>
    <div id="chatroom"></div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.1/signalr.js"></script>
    <script>
        var errorMessages = new Map();
        var error409 = 409;
        var error401 = 401;
        var Ok = 202;
        errorMessages.set(error409, "This login already in base");
        errorMessages.set(error401, "Wrong password or login");
        errorMessages.set(Ok, "New account created");
        function createErrorMessage(status) {
            const userNameElem = document.createElement("b");
            userNameElem.textContent = "Server: " + ` Status: ${status}: ` + errorMessages.get(status);

            // создает элемент <p> для сообщения пользователя
            const elem = document.createElement("p");
            elem.appendChild(userNameElem);

            const firstElem = document.getElementById("chatroom").firstChild;
            document.getElementById("chatroom").insertBefore(elem, firstElem)
        }

        let token;      // токен
        const hubConnection = new signalR.HubConnectionBuilder()
            .withUrl("/chat", { accessTokenFactory: () => token })
            .configureLogging(signalR.LogLevel.Information)
            .build();
        hubConnection.start()
            .catch(err => console.error(err.toString()));
        //registration
        document.getElementById("loginBtnReg").addEventListener("click", async () => {

            const response = await fetch("/reg", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    email: document.getElementById("emailReg").value,
                    password: document.getElementById("passwordReg").value
                })

            });

            // если запрос прошел нормально
            if (response.ok === true) {

                document.getElementById("loginBtnReg").disabled = true;
                console.log(`Status: ${emailReg}`);
                createErrorMessage(response.status);

            }

            else {


                createErrorMessage(response.status);

            }
        });

        // аутентификация
        document.getElementById("loginBtn").addEventListener("click", async () => {

            const response = await fetch("/login", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    email: document.getElementById("email").value,
                    password: document.getElementById("password").value
                })
            });

            // если запрос прошел нормально
            if (response.ok === true) {
                // получаем данные
                const data = await response.json();
                token = data.access_token;
                username = data.username;
                document.getElementById("loginBtn").disabled = true;
                document.getElementById("loginBtnReg").disabled = true;

                hubConnection.start()       // начинаем соединение с хабом
                    .then(() => document.getElementById("sendBtn").disabled = false)
                    .catch(err => console.error(err.toString()));
            }
            else {
                createErrorMessage(response.status);

            }
        });

        // отправка сообщения от простого пользователя
        document.getElementById("sendBtn").addEventListener("click", () => {

            const message = document.getElementById("message").value;
            const receiver = document.getElementById("receiver").value;
            hubConnection.invoke("Send", message, receiver)
                .catch(error => console.error(error));
        });

        // получение сообщения от пользователя
        hubConnection.on("Receive", (message, user) => {

            // создаем элемент <b> для имени пользователя
            const userNameElem = document.createElement("b");
            userNameElem.textContent = `${user}: `;

            // создает элемент <p> для сообщения пользователя
            const elem = document.createElement("p");
            elem.appendChild(userNameElem);
            elem.appendChild(document.createTextNode(message));

            const firstElem = document.getElementById("chatroom").firstChild;
            document.getElementById("chatroom").insertBefore(elem, firstElem);
        });

        // получени общего уведомления
        hubConnection.on("Notify", message => {

            const elem = document.createElement("p");
            elem.textContent = message;

            const firstElem = document.getElementById("chatroom").firstChild;
            document.getElementById("chatroom").insertBefore(elem, firstElem);
        });
        // получени error
        hubConnection.on("ReceiveError", message => {

            const userNameElem = document.createElement("b");
            userNameElem.textContent = "Server: ";

            // создает элемент <p> для сообщения пользователя
            const elem = document.createElement("p");
            elem.appendChild(userNameElem);
            elem.appendChild(document.createTextNode(message));

            const firstElem = document.getElementById("chatroom").firstChild;
            document.getElementById("chatroom").insertBefore(elem, firstElem);
        });
    </script>
</body>
</html>